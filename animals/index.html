<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Animal Safari</title>
    <!-- Friendly Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-top: #E0F7FA;
            --bg-bottom: #81ecec;
            --card-bg: #ffffff;
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --text-main: #2D3436;
            --accent: #FFE66D;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
            /* FIXED: Allow body to grow and scroll */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            /* overflow: hidden;  <-- REMOVED THIS */
        }

        /* ✨ PARTICLES CANVAS */
        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
        }

        /* 🏠 HOME BUTTON */
        .home-btn {
            /* FIXED: Keep button visible when scrolling */
            position: fixed; 
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            text-decoration: none;
            box-shadow: 0 4px 0 #cbd5e1;
            border: 2px solid #e2e8f0;
            z-index: 100;
            transition: transform 0.1s;
        }
        .home-btn:active { transform: translateY(4px); box-shadow: none; }

        /* --- LAYOUT --- */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-top: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            font-family: 'Fredoka One', cursive;
            color: var(--primary);
            font-size: 2.5rem;
            margin: 0 0 15px 0;
            margin-top: 60px; /* Increased space for fixed home button */
            text-shadow: 3px 3px 0px rgba(255,255,255,0.8);
            text-align: center;
            letter-spacing: 1px;
        }

        /* --- LEVEL SELECTOR --- */
        .level-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: rgba(255,255,255,0.5);
            padding: 5px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            /* Sticky header effect (optional) */
            position: sticky;
            top: 10px;
            z-index: 90;
            backdrop-filter: blur(5px);
        }

        .level-btn {
            border: none;
            background: transparent;
            font-family: 'Fredoka One', cursive;
            font-size: 1rem;
            color: #636e72;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .level-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
        }

        /* --- ANIMAL GRID --- */
        .safari-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 16px;
            width: 100%;
            padding: 10px;
            padding-bottom: 60px;
            /* Removed internal scrolling to let body scroll */
        }

        .animal-card {
            background: #fff;
            border-radius: 24px;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 4px solid #fff;
            box-shadow: 0 8px 15px rgba(0,0,0,0.05), 0 4px 0 #e2e8f0;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            opacity: 0; /* For entrance animation */
            animation: popIn 0.4s forwards;
        }

        .animal-card:active {
            transform: scale(0.92) translateY(4px) !important;
            box-shadow: 0 2px 0 #e2e8f0 !important;
        }

        .animal-emoji {
            font-size: 3.5rem;
            line-height: 1.2;
            filter: drop-shadow(0 4px 0 rgba(0,0,0,0.1));
        }
        
        .animal-name {
            font-family: 'Fredoka One', cursive;
            color: #636e72;
            font-size: 1.1rem;
            margin-top: 8px;
            text-align: center;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5) translateY(20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* --- STAGE OVERLAY (Pop-up) --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .stage-content {
            text-align: center;
            transform: scale(0.8) translateY(20px);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            background: white;
            padding: 40px;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border: 6px solid #f1f2f6;
            max-width: 90%;
        }

        .overlay.active .stage-content {
            transform: scale(1) translateY(0);
        }

        #stage-emoji {
            font-size: 8rem;
            display: block;
            margin-bottom: 10px;
            animation: floatEmoji 3s ease-in-out infinite;
        }

        @keyframes floatEmoji {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }

        #stage-text {
            font-family: 'Fredoka One', cursive;
            font-size: 3.5rem;
            color: var(--text-main);
            margin: 0;
            display: block;
        }

        #stage-subtext {
            font-family: 'Nunito', sans-serif;
            font-size: 1.5rem;
            color: var(--secondary);
            font-weight: 800;
            margin-top: 10px;
            opacity: 0.8;
        }

        .close-hint {
            position: absolute;
            bottom: 40px;
            font-size: 1.1rem;
            color: #b2bec3;
            font-weight: 700;
            animation: pulse 2s infinite;
            background: rgba(255,255,255,0.5);
            padding: 10px 20px;
            border-radius: 20px;
        }

        @keyframes pulse {
            0% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.6; transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .safari-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .animal-card { border-radius: 20px; }
            .animal-emoji { font-size: 3rem; }
            h1 { font-size: 2.2rem; }
            
            .stage-content { padding: 30px 20px; width: 85%; }
            #stage-emoji { font-size: 7rem; }
            #stage-text { font-size: 2.8rem; }
            #stage-subtext { font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <canvas id="particles"></canvas>
    
    <a href="/" class="home-btn" title="Back to Games">🏠</a>

    <div class="app-container">
        <h1>Animal Safari 🌍</h1>
        
        <div class="level-controls">
            <button class="level-btn active" onclick="loadLevel(1)">Level 1</button>
            <button class="level-btn" onclick="loadLevel(2)">Level 2</button>
            <button class="level-btn" onclick="loadLevel(3)">Level 3</button>
        </div>

        <div class="safari-grid" id="grid">
            <!-- Animals injected here -->
        </div>
    </div>

    <!-- Full Screen Overlay -->
    <div class="overlay" id="overlay">
        <div class="stage-content">
            <div id="stage-emoji">🦁</div>
            <div id="stage-text">Lion</div>
            <div id="stage-subtext">"Roar!"</div>
        </div>
        <div class="close-hint">Tap anywhere to close</div>
    </div>

    <script>
        /**
         * Animal Safari Configuration
         * Source: Google Search Animals (logos/fnbx/animal_sounds)
         */

        const GOOGLE_BASE = 'https://www.google.com/logos/fnbx/animal_sounds/';

        const LEVELS = {
            1: [ // Farm & Home
                { name: 'Dog', file: 'dog.mp3', emoji: '🐶', bg: '#e8f4ff' },
                { name: 'Cat', file: 'cat.mp3', emoji: '🐱', bg: '#fff0f6' },
                { name: 'Cow', file: 'cow.mp3', emoji: '🐮', bg: '#e6fffa' },
                { name: 'Pig', file: 'pig.mp3', emoji: '🐷', bg: '#fff0ef' },
                { name: 'Sheep', file: 'sheep.mp3', emoji: '🐑', bg: '#f1f2f6' },
                { name: 'Duck', file: 'duck.mp3', emoji: '🦆', bg: '#e6fffe' },
                { name: 'Chicken', file: 'chicken.mp3', emoji: '🐔', bg: '#ffeaea' },
                { name: 'Rooster', file: 'rooster.mp3', emoji: '🐓', bg: '#fff5e6' },
                { name: 'Horse', file: 'horse.mp3', emoji: '🐎', bg: '#fff0e6' },
                { name: 'Turkey', file: 'turkey.mp3', emoji: '🦃', bg: '#fff3e0' },
                { name: 'Rabbit', file: 'rabbit.mp3', emoji: '🐰', bg: '#fce4ec' },
                { name: 'Frog', file: 'frog.mp3', emoji: '🐸', bg: '#ebfbee' },
                { name: 'Owl', file: 'owl.mp3', emoji: '🦉', bg: '#f3e5f5' },
                { name: 'Mouse', file: 'rat.mp3', emoji: '🐭', bg: '#f3e5f5' }, // Using rat for mouse
                { name: 'Bird', file: 'robin.mp3', emoji: '🐦', bg: '#e3f2fd' }, // Robin as Bird
                { name: 'Dove', file: 'dove.mp3', emoji: '🕊️', bg: '#f5f5f5' },
                { name: 'Bee', file: 'bee.mp3', emoji: '🐝', bg: '#fffce6' },
                { name: 'Guinea Pig', file: 'guinea_pig.mp3', emoji: '🐹', bg: '#fff8e1' },
                { name: 'Ferret', file: 'ferret.mp3', emoji: '🦦', bg: '#d7ccc8' }
            ],
            2: [ // Wild & Forest
                { name: 'Lion', file: 'lion.mp3', emoji: '🦁', bg: '#fff3e0' },
                { name: 'Tiger', file: 'tiger.mp3', emoji: '🐯', bg: '#fff0eb' },
                { name: 'Elephant', file: 'elephant.mp3', emoji: '🐘', bg: '#f3f0ff' },
                { name: 'Zebra', file: 'zebra.mp3', emoji: '🦓', bg: '#f5f6fa' },
                { name: 'Giraffe', file: 'giraffe.mp3', emoji: '🦒', bg: '#fff3e0' },
                { name: 'Monkey', file: 'ape.mp3', emoji: '🐵', bg: '#fff9db' }, // Ape as Monkey
                { name: 'Panda', file: 'panda.mp3', emoji: '🐼', bg: '#fafafa' },
                { name: 'Wolf', file: 'wolf.mp3', emoji: '🐺', bg: '#cfd8dc' },
                { name: 'Moose', file: 'moose.mp3', emoji: '🫎', bg: '#d7ccc8' },
                { name: 'Raccoon', file: 'raccoon.mp3', emoji: '🦝', bg: '#eceff1' },
                { name: 'Otter', file: 'otter.mp3', emoji: '🦦', bg: '#e0f7fa' },
                { name: 'Penguin', file: 'penguin.mp3', emoji: '🐧', bg: '#e0f7fa' },
                { name: 'Swan', file: 'swan.mp3', emoji: '🦢', bg: '#fafafa' },
                { name: 'Whale', file: 'bowhead_whale.mp3', emoji: '🐳', bg: '#e1f5fe' },
                { name: 'Shark', file: 'shark.mp3', emoji: '🦈', bg: '#e0f2f1' },
                { name: 'Bat', file: 'bat.mp3', emoji: '🦇', bg: '#ede7f6' },
                { name: 'Hedgehog', file: 'hedgehog.mp3', emoji: '🦔', bg: '#d7ccc8' },
                { name: 'Leopard', file: 'leopard.mp3', emoji: '🐆', bg: '#fffde7' },
                { name: 'Hyena', file: 'hyena.mp3', emoji: '🐕', bg: '#d7ccc8' }
            ],
            3: [ // Exotic & Rare
                { name: 'Camel', file: 'camel.mp3', emoji: '🐫', bg: '#fff8e1' },
                { name: 'Buffalo', file: 'buffalo.mp3', emoji: '🐃', bg: '#cfd8dc' },
                { name: 'Yak', file: 'yak.mp3', emoji: '🐂', bg: '#d7ccc8' },
                { name: 'Alpaca', file: 'alpaca.mp3', emoji: '🦙', bg: '#f5f5f5' },
                { name: 'Antelope', file: 'antelope.mp3', emoji: '🦌', bg: '#efebe9' },
                { name: 'Rhino', file: 'rhinoceros.mp3', emoji: '🦏', bg: '#cfd8dc' },
                { name: 'Hippo', file: 'hippopotamus.mp3', emoji: '🦛', bg: '#eceff1' },
                { name: 'Alligator', file: 'alligator.mp3', emoji: '🐊', bg: '#c8e6c9' },
                { name: 'Snake', file: 'rattlesnake.mp3', emoji: '🐍', bg: '#e8f5e9' },
                { name: 'Lizard', file: 'lizard.mp3', emoji: '🦎', bg: '#c8e6c9' },
                { name: 'Dragon', file: 'komodo_dragon.mp3', emoji: '🐉', bg: '#dcedc8' },
                { name: 'Dino', file: 'dinosaur.mp3', emoji: '🦖', bg: '#c8e6c9' },
                { name: 'Scorpion', file: 'scorpion.mp3', emoji: '🦂', bg: '#ffe0b2' },
                { name: 'Anteater', file: 'anteater.mp3', emoji: '🐜', bg: '#d7ccc8' },
                { name: 'Parrot', file: 'african_grey_parrot.mp3', emoji: '🦜', bg: '#ffebee' },
                { name: 'Crow', file: 'crow.mp3', emoji: '🐦‍⬛', bg: '#eceff1' },
                { name: 'Falcon', file: 'falcon.mp3', emoji: '🦅', bg: '#cfd8dc' },
                { name: 'Big Whale', file: 'humpback_whale.mp3', emoji: '🐋', bg: '#e3f2fd' }
            ]
        };

        // --- GLOBAL STATE ---
        let state = {
            voice: null,
            isLocked: false,
            currentAudio: null,
            currentLevel: 1
        };

        // --- DOM ELEMENTS ---
        const grid = document.getElementById('grid');
        const overlay = document.getElementById('overlay');
        const stageEmoji = document.getElementById('stage-emoji');
        const stageText = document.getElementById('stage-text');
        const stageSub = document.getElementById('stage-subtext');
        const canvas = document.getElementById('particles');
        const homeBtn = document.querySelector('.home-btn');

        // --- INITIALIZATION ---
        function init() {
            setupVoice();
            loadLevel(1); // Default to Level 1
            setupCanvas();
            
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = setupVoice;
            }

            overlay.addEventListener('click', closeOverlay);
        }

        function setupVoice() {
            const voices = window.speechSynthesis.getVoices();
            state.voice = voices.find(v => v.name.includes('Google US English')) ||
                          voices.find(v => v.name.includes('Samantha')) ||
                          voices.find(v => v.lang === 'en-US') ||
                          voices[0];
        }

        // --- LEVEL LOGIC ---
        window.loadLevel = function(level) {
            state.currentLevel = level;
            
            // Update buttons
            document.querySelectorAll('.level-btn').forEach((btn, idx) => {
                if (idx + 1 === level) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // Re-render Grid
            renderGrid(LEVELS[level]);
        }

        function renderGrid(animals) {
            grid.innerHTML = '';
            animals.forEach((animal, index) => {
                const card = document.createElement('div');
                card.className = 'animal-card';
                card.style.borderColor = animal.bg; 
                card.style.animationDelay = `${index * 0.05}s`; 
                
                card.style.background = `linear-gradient(135deg, #ffffff 40%, ${animal.bg} 100%)`;

                const emoji = document.createElement('div');
                emoji.className = 'animal-emoji';
                emoji.textContent = animal.emoji;

                const name = document.createElement('div');
                name.className = 'animal-name';
                name.textContent = animal.name;
                name.style.color = '#2d3436'; 

                card.appendChild(emoji);
                card.appendChild(name);

                const interact = (e) => {
                    e.preventDefault();
                    activateAnimal(animal, e);
                };

                card.addEventListener('click', interact);
                card.addEventListener('touchstart', interact, {passive: false});

                grid.appendChild(card);
            });
        }

        function activateAnimal(animal, e) {
            if (state.isLocked) return;
            state.isLocked = true;

            // Stop any previous sound immediately
            stopAudio();

            // 1. Pop Visuals
            stageEmoji.textContent = animal.emoji;
            stageText.textContent = animal.name;
            stageText.style.color = '#2d3436';
            stageSub.textContent = "🔊 Listening...";
            
            overlay.classList.add('active');

            // 2. Particles
            let x = window.innerWidth / 2;
            let y = window.innerHeight / 2;

            if (e) {
                if (e.touches && e.touches.length > 0) {
                    x = e.touches[0].clientX;
                    y = e.touches[0].clientY;
                } else if (e.clientX !== undefined) {
                    x = e.clientX;
                    y = e.clientY;
                }
            }

            createExplosion(x, y, '#FF6B6B');

            // 3. Audio Logic
            setTimeout(() => {
                playAnimalSound(animal);
            }, 300);
        }

        function playAnimalSound(animal) {
            const fullUrl = GOOGLE_BASE + animal.file;
            const audio = new Audio(fullUrl);
            state.currentAudio = audio;
            
            // LOOPING LOGIC: Enable loop
            audio.loop = true;
            
            // Fallback to TTS if audio fails
            audio.onerror = (e) => {
                console.log("Audio failed to load, falling back to TTS", e);
                speak(`The ${animal.name} says hello!`);
            };

            // Play
            audio.play().catch(e => {
                console.log("Autoplay prevented or error", e);
                speak(`The ${animal.name} says hello!`); 
            });
        }

        function stopAudio() {
            // Stop TTS
            window.speechSynthesis.cancel();
            
            // Stop Real Audio
            if (state.currentAudio) {
                state.currentAudio.pause();
                state.currentAudio.currentTime = 0;
                state.currentAudio = null;
            }
        }

        function closeOverlay() {
            overlay.classList.remove('active');
            stopAudio();
            setTimeout(() => {
                state.isLocked = false;
            }, 300);
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            if (state.voice) utterance.voice = state.voice;
            utterance.rate = 0.9;
            utterance.pitch = 1.1; 
            window.speechSynthesis.speak(utterance);
        }

        // --- PARTICLE SYSTEM ---
        const ctx = canvas.getContext('2d');
        let particles = [];

        function setupCanvas() {
            const resize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', resize);
            resize();
            animateParticles();
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.color = color;
                this.size = Math.random() * 12 + 6; 
                this.speedX = Math.random() * 10 - 5;
                this.speedY = Math.random() * 10 - 5;
                this.life = 100;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += 0.3; // Gravity
                this.life -= 1.5;
                this.size *= 0.94;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 45; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                    i--;
                }
            }
            requestAnimationFrame(animateParticles);
        }

        init();

    </script>
</body>
</html>